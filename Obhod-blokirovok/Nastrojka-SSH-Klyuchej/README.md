# Настройка доступа к VPS по ssh ключу

## Настраиваем безопасность скриптом:

Скрипт для создания, изменения и передачи SSH-ключей (RSA или ED25519),а также для редактирования параметров входа по паролю на удалённом сервере. Поддерживаемые системы хоста и сервера: Ubuntu/Debian, Fedora/RHEL/CentOS, macOS, WSL (теоретически. Тщательно тестировал только на Ubuntu/Debian/CentOS. Пишите сюда в issues или комментах о проблемах,будем поправлять).

Скрипт может запускаться как от имени root, так и с sudo.

Для запуска скрипта выполняем, в зависимости от системы, эту команду на машине-хосте (откуда хотите заходить на сервер по ключу):

```sudo wget -O ssh-keys-linux-mac-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/Obhod-blokirovok/Nastrojka-SSH-Klyuchej/ssh-keys-linux-mac-itf.sh && sudo bash ssh-keys-linux-mac-itf.sh```

или эту:

```sudo curl -o ssh-keys-linux-mac-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/Obhod-blokirovok/Nastrojka-SSH-Klyuchej/ssh-keys-linux-mac-itf.sh && sudo bash ssh-keys-linux-mac-itf.sh```

Если пакета sudo на машине нет и запускаете от имени root, уберите из команды слово sudo.

Функционал:
   1. Проверка наличия SSH и папки ~/.ssh.
   2. Главное меню для выбора:
         - выбор типа ключа (RSA или ED25519),
         - задание имени файла,
         - если ключ существует, предлагается меню:
             1) Ввести другое имя
             2) Отменить
             3) Перезаписать (создать заново)
             4) Изменить парольную фразу
             5) Изменить комментарий
             6) Передать ключ на сервер
             7) Добавить ключ в ssh-agent
             8) Убрать все ключи из ssh-agent
         - Если ключа нет, он создаётся (с запросом комментария и парольной фразы).
   3. Передача ключа на сервер:
         - Сначала используется ssh-copy-id с уже загруженными ключами.
         - Если возникает ошибка (например, "Too many authentication failures"),
           ssh-agent очищается (ssh-add -D) и попытка повторяется.
         - Если ключи не подходят, стандартный ssh-copy-id запросит пароль.
   4. Финальная настройка:
         - После успешной передачи ключа выводится текущее состояние параметра 
           PasswordAuthentication на сервере.
         - Для не‑root‑пользователя запрашивается sudo-пароль один раз.
         - После этого локально запрашивается выбор: включить или отключить вход по паролю.
         - Команды на сервер отправляются через SSH:
      
             - Если пользователь root – команды выполняются напрямую.
           -  Иначе – команды выполняются через sudo (каждая команда получает sudo-пароль).
           


## А теперь вариант настройки ssh ключей руками, а не скриптом:

1. Проверьте, что команда ssh доступна:\
```command -v ssh >/dev/null 2>&1 && echo "SSH уже установлен" || echo "SSH не установлен"```\
или:\
```which ssh```

2. Если SSH не найден, установите его.
   
   Для Ubuntu/Debian можно выполнить:\
   ```sudo apt-get update && sudo apt-get install -y openssh-client```

   Для Fedora/RHEL/CentOS (используется пакетный менеджер dnf):\
   ```sudo dnf install -y openssh-clients```
   
   Или на RHEL/CentOS 7 и старее:\
   ```sudo yum install -y openssh-clients```
   
   Для macOS (при наличии Homebrew):\
   ```brew install openssh```
   
3. Создание каталога ~/.ssh (если отсутствует):\
   ```mkdir -p ~/.ssh```\
   ```chmod 700 ~/.ssh```\
   ```ls -ld ~/.ssh```\

4.  Создание (или изменение) SSH-ключа (обычно RSA или ED25519, также введите нужное имя ключа):\
    ```ssh-keygen -t rsa -C "комментарий/описание" -f ~/.ssh/id_rsa```\
    Можно добавить опцию -b 4096 для увеличения длины RSA ключа. Далее вас попросят ввести парольную фразу (необязательно). \
    или:\
    ```ssh-keygen -t ed25519 -C "комментарий" -f ~/.ssh/id_ed25519```\
    Аналогично можно задать/не задать парольную фразу.

5. Изменение парольной фразы уже существующего ключа (введите нужное имя ключа):\
   ```ssh-keygen -p -f ~/.ssh/id_ed25519```

7. Изменение комментария уже существующего ключа (введите нужное имя ключа и комментарий):\
   ```ssh-keygen -c -f ~/.ssh/id_ed25519 -C "НовыйКомментарий"```

8. Добавление ключа в ssh-agent, чтобы один раз ввести парольную фразу и не вводить её при каждом вызове SSH:
   
   Проверьте, запущен ли он:\
   ```eval "$(ssh-agent -s)"```
   
   Добавьте туда ключ (введите нужное имя ключа):\
   ```ssh-add ~/.ssh/id_ed25519```
   
   Показывает список добавленных ключей:\
   ```ssh-add -l```

    Удалить все добавленные ключи:\
   ```ssh-add -D```






