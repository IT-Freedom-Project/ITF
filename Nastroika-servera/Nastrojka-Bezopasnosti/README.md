# Базовая настройка безопасности VPS
Видео - https://www.youtube.com/watch?v=EAMctAR69jA
## Настраиваем безопасность скриптом:

Скрипт настраивает базовую безопасность VPS. Вы будете выбирать, какие операции провести, и будете вводить необходимые значения. Скрипт запускается непосредственно не VPS, который нужно настроить.

Для запуска скрипта выполняем эту команду:

```sudo wget -O security-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/Nastroika-servera/Nastrojka-Bezopasnosti/security-itf.sh && sudo bash security-itf.sh```

или эту:

```sudo curl -o security-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/Nastroika-servera/Nastrojka-Bezopasnosti/security-itf.sh && sudo bash security-itf.sh```

Что происходит при запуске скрипта:

1. **Хотите обновить систему? (yes/no)**: вам предложат обновить систему. Лучше обновить. После обновления может возникнуть синий экран с выбором сервисов для перезагрузки. Просто нажмите Enter.

2. **Хотите изменить пароль root? (yes/no)**: вам предложат изменить пароль встроенного системного пользователя-администратора Linux - root. Лучше поменять.

   2.1 **Введите пароль и подтверждение пароля.**
   - Пароль должен быть не менее 12 символов.
   - Пароль должен содержать хотя бы одну букву нижнего регистра (латинскую или русскую).
   - Пароль должен содержать хотя бы одну букву верхнего регистра (латинскую или русскую).
   - Пароль должен содержать хотя бы одну цифру.
   - Пароль должен содержать хотя бы один специальный символ.

3. **Хотите создать нового пользователя? (yes/no)**:  вам предложат создать нового пользователя-администратора Linux. Лучше создать и заходить в систему уже под его аккаунтом. Если хотите поменять пароль уже существующего пользователя, просто напишите его имя при создании.

   3.1 **Введите имя пользователя.** Имя пользователя должно быть от 1 до 32 символов. Имя пользователя должно начинаться с буквы или подчеркивания, и содержать только строчные буквы, цифры, дефисы и подчеркивания.

   3.2 **Введите пароль и подтверждение пароля** (требования как в 2.1)

   3.3. **Разрешить выполнение команд без пароля? (yes/no)**: вам предложит добавить пользователя в группу выполнения команд без ввода пароля в sudo. Это надо, например, для Amnezia, если вы там указываете не root пользователя в настройках подключения к серверу. Скрипт предложит отключить эту настройку, если она уже включена.

4. **Хотите отключить вход root по SSH? (yes/no)**: вам предложат отключить вход через ssh для root пользователя. Лучше отключить ЕСЛИ ВЫ УЖЕ СОЗДАЛИ ДРУГОГО ПОЛЬЗОВАТЕЛЯ и можете войти под его данными. Под аккаунтом root через ssh на сервер будет больше не попасть. Скрипт предложит отключить эту настройку, если она уже включена.

5. **Хотите изменить порт SSH? (yes/no)**: вам предложат изменить порт для SSH по умолчанию. Лучше изменить. Диапазон 1024-65535. При смене порта ufw будет отключён, если он активен.

6. **Хотите настроить ufw? (yes/no)**: вам предложат настроить файрволл, который закрывает входящий трафик на все порты, кроме текущего порта ssh. Лучше настроить.

7. **Хотите настроить fail2ban? (yes/no)**: вам предложат настроить систему защиту от брутфорса на ssh порту. Лучше настроить.

8. **qemu-guest-agent установлен и активен. Хотите остановить и отключить его? (yes/no)**: вам предложат отключить службу, через которую хостер может управлять системой на VPS (сбросить пароль для root и пр.). При этом в личном кабинете не будет видна статистика нагрузки VPS и сбросить пароль для root вы больше не сможете, что может быть неудобно. Учтите, хостинг всё равно может иметь доступ к файловой системе вашего сервера. Скрипт предложит включить службу обратно, если она уже отключена. Отключать или нет - дело вкуса и конкретной ситуации.


## А теперь вариант настройки безопасности руками, а не скриптом:

1. Обновляем систему:\
```sudo apt update``` \
```sudo apt upgrade -y```

2. Меняем пароль root:\
```sudo passwd root```

   Два раза введите пароль.

4. Создаём нового пользователя (напишите имя вместо USERNAME):\
```sudo adduser --gecos "" USERNAME```

   Два раза введите пароль.

   Для смены пароля существующего пользователя (напишите имя вместо USERNAME):\
   ```sudo passwd USERNAME```
   
   Два раза введите пароль.

6. Добавьте пользователя в группу sudo, чтобы он мог выполнять команды от имени суперпользователя (напишите имя вместо USERNAME):\
```sudo usermod -aG sudo USERNAME```

7. Если вы хотите разрешить пользователю выполнять команды без ввода пароля (напишите имя вместо USERNAME):\
```echo 'USERNAME ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/USERNAME```

   Если хотите запретить опять:\
   ```sudo rm /etc/sudoers.d/USERNAME```

8. Отключение или включение доступа root по SSH:

   Откройте файл конфигурации SSH:\
   ```sudo nano /etc/ssh/sshd_config```

   Найдите строку PermitRootLogin и измените её значение на no, чтобы отключить доступ root по SSH:\
   ```PermitRootLogin no```

   Или на yes, чтобы включить доступ root по SSH:\
   ```PermitRootLogin yes```

   Нажмите Ctrl + O, Enter, Ctrl + X чтобы сохранить изменения.

   Перезапустите службу SSH:\
   ```sudo systemctl restart sshd || sudo systemctl restart ssh```

9. Изменение порта SSH:
   Отключите UFW (если он активен) перед изменением порта:\
   ```sudo ufw disable```

   Откройте файл конфигурации SSH:\
   ```sudo nano /etc/ssh/sshd_config```

   Найдите или добавьте строку Port и установите нужный вам порт (напишите номер порта вместо NEWPORT):\
   ```Port NEWPORT```

   Нажмите Ctrl + O, Enter, Ctrl + X чтобы сохранить изменения.
   
   Перезапустите службу SSH: \
   ```sudo systemctl restart sshd || sudo systemctl restart ssh```

10. Настройка UFW (Firewall):
   
   Установите UFW:\
   ```sudo apt install -y ufw```
   
   Разрешите новый порт SSH (напишите номер порта вместо SSHPORT) и другие необходимые порты:\
   ```sudo ufw allow SSHPORT/tcp```
   
   Включите UFW:\
   ```sudo ufw enable```

   Проверьте статус UFW:\
   ```sudo ufw status```
   
11. Установка и настройка Fail2ban:
    
    Установите Fail2ban:\
    ```sudo apt install -y fail2ban```

    Настройте Fail2ban для защиты SSH:\
    ```sudo nano /etc/fail2ban/jail.local```

    Добавьте следующие строки в файл (напишите номер порта вместо SSHPORT):\
    ```[sshd]```\
    ```enabled = true```\
    ```port = SSHPORT  # Ваш новый порт SSH```\
    ```filter = sshd```\
    ```logpath = /var/log/auth.log```\
    ```maxretry = 5``` 

    Нажмите Ctrl + O, Enter, Ctrl + X чтобы сохранить изменения.

    Перезапустите Fail2ban:\
    ```sudo systemctl restart fail2ban```

12. Остановка qemu-guest-agent (по желанию, вы должны понимать все плюсы и минусы):
    
    Остановите и отключите qemu-guest-agent (если установлен):\
    ```sudo systemctl stop qemu-guest-agent```\
    ```sudo systemctl disable qemu-guest-agent```\
    ```sudo systemctl mask qemu-guest-agent```
    
    Или включите его обратно:\
    ```sudo systemctl unmask qemu-guest-agent```\
    ```sudo systemctl enable qemu-guest-agent```\
    ```sudo systemctl start qemu-guest-agent```
    
  ## Как заходить на VPS после настройки безопасности:

 Вы должны указать вместо root имя созданного пользователя и порт. Например:
 
```ssh testuser@123.123.123.123 -p34567```
