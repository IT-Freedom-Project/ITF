# Настройка доступа к VPS по ssh ключу

## Настраиваем безопасность скриптом:

Скрипт для создания, изменения и передачи SSH-ключей (RSA или ED25519),а также для редактирования параметров входа по паролю на удалённом сервере. Поддерживаемые системы хоста и сервера: Ubuntu/Debian, Fedora/RHEL/CentOS, macOS, WSL (теоретически. Тщательно тестировал только на Ubuntu/Debian/CentOS. Пишите сюда в issues или комментах о проблемах,будем поправлять).

Скрипт может запускаться от имени любого пользователя.

Для запуска скрипта выполняем, в зависимости от системы, эту команду на машине-хосте (откуда хотите заходить на сервер по ключу):

```
sudo wget -q -O ssh-keys-linux-mac-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/nastrojka-servera/nastrojka-ssh-klyuchej/ssh-keys-linux-mac-itf.sh && bash ssh-keys-linux-mac-itf.sh
```

или эту:

```
sudo curl -o ssh-keys-linux-mac-itf.sh https://raw.githubusercontent.com/IT-Freedom-Project/ITF/main/nastrojka-servera/nastrojka-ssh-klyuchej/ssh-keys-linux-mac-itf.sh && bash ssh-keys-linux-mac-itf.sh
```

Если пакета sudo на машине нет и запускаете от имени root, уберите из команды слово sudo. Сам по себе скачанный скрипт ssh-keys-linux-mac-itf.sh требуется выполнять НЕ ЧЕРЕЗ SUDO, иначе ключи будут создаваться для root, а не для текущего пользователя. Sudo в командах выше стоит только для wget и curl.

Функционал:
   1. Проверка наличия SSH и папки ~/.ssh.
   2. Главное меню для выбора:
         - выбор типа ключа (RSA или ED25519),
         - задание имени файла,
         - если ключ существует, предлагается меню:
             1) Ввести другое имя
             2) Отменить
             3) Перезаписать (создать заново)
             4) Изменить парольную фразу
             5) Изменить комментарий
             6) Передать ключ на сервер
             7) Добавить ключ в ssh-agent
             8) Убрать все ключи из ssh-agent
         - Если ключа нет, он создаётся (с запросом комментария и парольной фразы).
         - убрать все ключи из ssh-agent
   3. Передача ключа на сервер:
         - Сначала используется ssh-copy-id с уже загруженными ключами.
         - Если возникает ошибка (например, "Too many authentication failures"),
           ssh-agent очищается (ssh-add -D) и попытка повторяется.
         - Если ключи не подходят, стандартный ssh-copy-id запросит пароль.
   4. Финальная настройка:
         - После успешной передачи ключа предлагает настроить вход по паролю на сервере.
         - При согласии выводится текущее состояние параметра PasswordAuthentication на сервере.
         - Для не‑root‑пользователя запрашивается sudo-пароль один раз.
         - После этого локально запрашивается выбор: включить или отключить вход по паролю.
         - Команды на сервер отправляются через SSH:
      
             - Если пользователь root – команды выполняются напрямую.
           -  Иначе – команды выполняются через sudo (каждая команда получает sudo-пароль).
           


## А теперь вариант настройки ssh ключей руками, а не скриптом:

1. Проверьте, что команда ssh доступна:
   ```
   command -v ssh >/dev/null 2>&1 && echo "SSH уже установлен" || echo "SSH не установлен"
   ```
   или (покажет путь к пакету):
   ```
   which ssh
   ```

2. Если SSH не найден, установите его.
   
   Для Ubuntu/Debian можно выполнить:
   ```
   sudo apt-get update && sudo apt-get install -y openssh-client
   ```

   Для Fedora/RHEL/CentOS (используется пакетный менеджер dnf):
   ```
   sudo dnf install -y openssh-clients
   ```
   
   Или на RHEL/CentOS 7 и старее:
   ```
   sudo yum install -y openssh-clients
   ```
   
   Для macOS (при наличии Homebrew):
   ```
   brew install openssh
   ```
   
3. Создание каталога ~/.ssh (если отсутствует):
   ```
   mkdir -p ~/.ssh
   chmod 700 ~/.ssh
   ls -ld ~/.ssh
   ```

4. Создание (или изменение) SSH-ключа (обычно RSA или ED25519).\
   Если в формате RSA (введите нужное имя ключа вместо id_rsa):
   ```
   ssh-keygen -t rsa -C "комментарий/описание" -f ~/.ssh/id_rsa
   ```
   Можно добавить опцию -b 4096 для увеличения длины RSA ключа. Далее вас попросят ввести парольную фразу (необязательно).
   
   Или делаем в формате Ed25519, что рекомендую (введите нужное имя ключа вместо id_ed25519):
   ```
   ssh-keygen -t ed25519 -C "комментарий" -f ~/.ssh/id_ed25519
   ```
   Аналогично можно задать/не задать парольную фразу.

5. Изменение парольной фразы уже существующего ключа (введите нужное имя ключа вместо id_ed25519):
   ```
   ssh-keygen -p -f ~/.ssh/id_ed25519
   ```

6. Изменение комментария уже существующего ключа (введите нужное имя ключа вместо id_ed25519 и комментарий):
   ```
   ssh-keygen -c -f ~/.ssh/id_ed25519 -C "НовыйКомментарий"
   ```

7. Добавление ключа в ssh-agent, чтобы один раз ввести парольную фразу и не вводить её при каждом вызове SSH:
   
   Проверьте, запущен ли он:
   ```
   eval "$(ssh-agent -s)"
   ```
   
   Добавьте туда ключ (введите нужное имя ключа вместо id_ed25519):
   ```
   ssh-add ~/.ssh/id_ed25519
   ```
   
   Показывает список добавленных ключей:
   ```
   ssh-add -l
   ```

    Удалить все добавленные ключи:
   ```
   ssh-add -D
   ```
   
8. Передача ключа на удалённый сервер (введите нужное имя ключа вместо id_ed25519.pub, нужный порт в Port (22 по умолчанию), логин вместо remote_user и ip вместо remote_host):
   ```
   ssh-copy-id -i ~/.ssh/id_ed25519.pub -p PORT remote_user@remote_host
   ```
   ssh-copy-id попросит пароль для удалённого пользователя (пароль от учётной записи на сервере).

   Если ошибка "Too many authentication failures" из-за того, что вы добавили много ключей в ssh-agent (скажем, для каждого сервера свой, что не рекомендую без доп. настроек), то сбрасываем их:
   ```
   ssh-add -D
   ```
   и повторяем c заменой на нужные значения:
   ```
   ssh-copy-id -i ~/.ssh/id_ed25519.pub -p PORT remote_user@remote_host
   ```

   Если вдруг ssh-copy-id работает некорректно, то пробуем (введите нужное имя ключа вместо id_ed25519.pub, нужный порт в Port (22 по умолчанию), логин вместо remote_user и ip вместо remote_host):
   ```
   cat ~/.ssh/id_ed25519.pub | ssh -p PORT remote_user@remote_host \
   "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
   ```
   При необходимости SSH запросит пароль.

9. Изменение настройки входа по паролю на сервере.
    
   Сначала заходим на удалённый сервер как root или пользователь с правами sudo. 
   Если надо отключить вход по паролю:
   ```
   sudo sed -i 's/^[#[:space:]]*PasswordAuthentication[[:space:]]\+yes/PasswordAuthentication no/' /etc/ssh/sshd_config
   ```
   Потом перезагружаем SSH:
   ```|
   sudo systemctl restart sshd || sudo systemctl restart ssh
   ```
   Если надо включить вход по паролю:
   ```
   sudo sed -i 's/^[#[:space:]]*PasswordAuthentication[[:space:]]\+no/PasswordAuthentication yes/' /etc/ssh/sshd_config
   ```
   Потом перезагружаем SSH:
   ```|
   sudo systemctl restart sshd || sudo systemctl restart ssh
   ```
   Если хочется совсем уж ручками. Выполняем на примере редактора nano (если вы зашли как root и в системе нет sudo, то уберите из команд sudo).
   ```
   sudo nano /etc/ssh/sshd_config
   ```
   Ищем строку:
   ```
   #PasswordAuthentication yes
   ```
   Меняем на:
   ```
   PasswordAuthentication no
   ```
   Нажимаем Ctrl + O , потом Ctrl + X. Если надо снова включить вход по паролю, то меняем no на yes обратно.
   После изменений выполняем:
   ```
   sudo systemctl restart sshd || sudo systemctl restart ssh
   ```








